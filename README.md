# Интересная Москва
Навык Алисы для подбора и планирования мероприятий в Москве.
Разработан для **Moscow City Hack 2021**!

## Запуск
> На смартфоне должно быть установлено [мобильное приложение Яндекса или Яндекс.Браузер](https://mobile.yandex.ru/)

Запустить навык можно двумя способами:
1. сказать Алисе `Запусти навык Интересная Москва`
2. или открыть [ссылку](https://alice.ya.ru/s/20274d48-0658-456b-812d-e5babf55db78)

## Схема работы
Запросы и ответы обрабатываются приложением согласно [протоколу Алисы](https://yandex.ru/dev/dialogs/alice/doc/protocol.html).
В процессе движения по сценарию пользователь перемещается между сценами (папка `src/scenes`).
В каждой сцене фраза пользователя ловится одним из компонентов.
Далее компонент обновляет стейт пользователя, возможно переводит на новую сцену и формирует ответ.
Для подбора событий в стейте храним следующие фильтры:
 - `dateRange`: даты поиска
 - `free`: бесплатное/любое
 - `forChildren`: для детей/для всех
 - `spheres`: список id сфер

Также храним в стейте список уже показанных событий, чтобы не дублировать.
Фильтры заполняются по ответам пользователя, и дальше в цикле ему предлагаются события списком по 3.
Если события закончились, то предлагаем пользователю сменить фильтр.

## Структура проекта
Дерево основных папок проекта с описаниями:
```
src
  events        // работа с апи мос.ру
  generated     // ссылки на звуки
  protocol      // протокол алисы
  scenes        // сценарии диалога
  state         // стейт пользователя
  utils         // утилитарные штуки
test            // тесты
bot-components  // фреймворк для ботов
scripts         // скрипты для деплоя и тестирования
data            // json-ы с примерами данных от апи мос.ру
```

## Локальное развертывание
Для локальной разработки нужна установленная Node.js >= 14.
1. Склонировать репозиторий
   ```
   git clone https://github.com/vitalets/skill-afisha-moscow
   ```
2. Установить зависимости
   ```
   cd skill-afisha-moscow
   npm i
   ```
3. Настроить гит-хуки
   ```
   git config core.hooksPath ./scripts/hooks
   ```
4. Завести в корне проекта `.env` файл следующего содержания:
    ```
    YC_FUNCTION_ID=xxx   # id функции
    SKILL_ID=yyy         # id навыка
    ALICE_TOKEN=zzz      # oauth token аккаунта в Яндексе
    ```
## Запуск тестов
```
npm run test
```
Запросы к апи мос.ру мокаются.

## Сборка и релиз
Навык выкладывается в виде облачной функции на Yandex Cloud. Выложить версию можно командой:
```
npm run deploy
```
